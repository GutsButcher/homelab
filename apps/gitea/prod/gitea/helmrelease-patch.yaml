apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: gitea
  namespace: gitea
spec:
  values:
    nodeSelector:
      kubernetes.io/hostname: worker-node
    tolerations:
      - key: "node"
        operator: "Equal"
        value: "worker-node"
        effect: "NoSchedule"
    
    # Disable built-in PostgreSQL HA subchart - using CNPG instead
    postgresql-ha:
      enabled: false
    postgresql:
    enabled: false
    # Configure Gitea to use external CNPG database
    gitea:
      admin:
        existingSecret: gitea-admin-secret
      config:
        APP_NAME: "Gitea: With a cup of tea."
        repository:
          ROOT: "~/gitea-repositories"
        repository.pull-request:
          WORK_IN_PROGRESS_PREFIXES: "WIP:,[WIP]:"
        database:
          DB_TYPE: postgres
          HOST: gitea-postgres-rw.gitea.svc.cluster.local:5432
      additionalConfigFromEnvs:
        - name: GITEA__DATABASE__NAME
          valueFrom:
            secretKeyRef:
              name: gitea-postgres-credentials
              key: database
        - name: GITEA__DATABASE__USER
          valueFrom:
            secretKeyRef:
              name: gitea-postgres-credentials
              key: username
        - name: GITEA__DATABASE__PASSWD
          valueFrom:
            secretKeyRef:
              name: gitea-postgres-credentials
              key: password
        - name: GITEA__DATABASE__SCHEMA
          valueFrom:
            secretKeyRef:
              name: gitea-postgres-credentials
              key: schema
    persistence:
      enabled: true
      create: true
      mount: true
      size: 10Gi
      storageClass: local-path
      accessModes:
        - ReadWriteOnce
